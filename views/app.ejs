<html>
	<head>
		<meta http_equiv=Content-Type content="text/html; charset=utf_8">
		<script src="http://cdn.bootcss.com/socket.io/1.3.5/socket.io.js"></script>
		<script src="http://libs.baidu.com/jquery/2.0.0/jquery.js"></script>
		<title id="page_title"></title>
                <style type="text/css">
                        div#moveable{
                                position:relative;
                        }
                </style>
                <script>
                $(document).ready(function(){
                        var atAllElement=function(css,callback){
                                var ele_list=$(css);
                                for(var i=0;i<ele_list.length;i++){
                                        var ele=ele_list[i];
                                        callback.call(undefined,ele);//"call"的第一个参数是"this"
                                }
                        } 
                        var moveRelativeDiv=function(dx,dy){
                                atAllElement("div#moveable",function(div){
                                        div.style.left=parseInt(div.style.left||0)+dx;
                                        div.style.top=parseInt(div.style.top||0)+dy;
                                });
                        };//要加分号否则后面的括号会被当作调用运算符
                        (function(){
                                atAllElement("div#moveable",function(div){
                                        $(div).bind("contextmenu",function(evt){
                                                return false;
                                        });
                                });
                        }).call();//只阻止可拖拽方块的右键
                        //支持拖拽
                        (function(){
                                var mouse_over=false;
                                var mx=undefined,my=undefined;
                                var start=function(evt){
                                        if(evt.which!=3||mouse_over) return;
                                        console.log("in!");
                                        mouse_over=true;
                                        mx=evt.clientX;
                                        my=evt.clientY;
                                }
                                var stop=function(evt){
                                        if(evt.which!=3||!mouse_over) return;
                                        console.log("out!");
                                        mouse_over=false;
                                        mx=undefined;
                                        my=undefined;
                                }
                                $("div#moveable").on("mousedown",start);
                                $("div#moveable").on("mouseup",stop);
                                $("div#moveable").on("mouseout",stop);
                                $("div#moveable").on("mouseenter",stop);
                                $("div#moveable").on("mousemove",function(evt){
                                        if(!mouse_over) return;
                                        var dx=evt.clientX-mx,dy=evt.clientY-my;
                                        moveRelativeDiv(dx,dy);
                                        mx=evt.clientX;
                                        my=evt.clientY;
                                });
                        }).call();
                        //键盘移动
                        (function(){
                                var speed=10;
                                $(document).keydown(function(evt){
                                        var dx=0,dy=0;
                                        switch(evt.keyCode||evt.which){
                                                case 87:dy=speed;break;//W
                                                case 83:dy=-speed;break;//S
                                        }
                                        switch(evt.keyCode||evt.which){
                                                case 65:dx=speed;break;//A
                                                case 68:dx=-speed;break;//D
                                        }
                                        divRelativeMove(dx,dy);
                                });
                        }).call();
                });
                </script>
                <script>
                        function getUsername(){
                                return "<%=username%>";
                                //~ return window.location.hash.replace(/^#/,"") || "<Unknown>";
                        }
                        function getRoomname(){
                                return "<%=roomname%>";
                        }
                        function addTextMessage(message){
                                var divs=$("#text_messages");
                                var para=document.createElement("p");
                                para.textContent=message.author+": "+message.text;
                                divs.append(para);
                                
                        }
                        function sendTextMessage(){
                                var text=$("#text_message_input").val();
                                if(!text) return;
                                message={
                                        author: getUsername(),
                                        room:   getRoomname(),
                                        text: text,
                                };
                                socket.emit("text_message",message);
                                $("#text_message_input").val("");
                                addTextMessage(message);
                        }
                </script>
	</head>
	<body>
                <h1 id="username"></h1>
                <div id="text_messages">
                </div>
                <div id="text_message_send">
                        <input id="text_message_input"></input>
                        <button id="text_message_button">发送</button>
                </div>
                <script>
                        var socket=io.connect("localhost:8080");
                        socket.emit('enter_room',{
                                room: getRoomname(),
                                user: getUsername(),
                        });
                        window.onunload=function(){
                                socket.emit('leave_room',{
                                        room: getRoomname(),
                                        user: getUsername(),
                                });
                        }
                        $("#text_message_button").on("click",sendTextMessage);
                        $("#text_message_input").keydown(function(event){
                                if(event.keyCode==13)//按下回车事件
                                        sendTextMessage();
                        });
                        socket.on("text_message",function(message){
                                addTextMessage(message);
                        });
                        $("#username").text(getUsername()+"@"+getRoomname());
                        $("#page_title").text(getUsername()+"@"+getRoomname());
                </script>
                <!-- 下面这部分是用来测试拖拽和键盘控制移动的 -->
                <div id="moveable" style="width: 100px;height: 100px; background: green;left:500"></div>
                <div id="moveable" style="width: 100px;height: 100px; background: green;left:500;top:100px; "></div>

        </body>
</html>
